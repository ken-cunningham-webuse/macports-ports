# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

platforms           darwin
name                mesa
categories          x11 graphics
maintainers         {jeremyhu @jeremyhu} openmaintainer
license             MIT
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification,\
                    a system for rendering interactive 3D graphics.

homepage            https://www.mesa3d.org
master_sites        https://archive.mesa3d.org

epoch               1

if {${os.major} > 15} {

    PortGroup           meson 1.0

    version             21.0.1
    revision            0
    use_xz              yes

	checksums           rmd160  db3e5d44cec00ffe085deadbcfb776a494632466 \
						sha256  379fc984459394f2ab2d84049efdc3a659869dc1328ce72ef0598506611712bb \
						size    14648932

    depends_build-append \
                        port:pkgconfig \
                        port:flex \
                        port:bison \
                        port:gindent

    depends_lib-append  port:expat \
                        port:xorg-xorgproto \
                        port:xorg-libxcb \
                        port:xorg-libX11 \
                        port:xorg-libXext \
                        port:xorg-libXdamage \
                        port:xorg-libXfixes \
                        port:xorg-libXi \
                        port:xorg-libXmu \
                        port:xorg-libXxf86vm

    patch.pre_args      -p1
    patchfiles          0001-darwin-Use-the-system-libunwind.patch \
                        0002-darwin-Use-the-system-libexpat.patch \
                        0003-Hack-to-address-build-failure-when-using-newer-macOS.patch \
                        0004-patch-mesa-spec-python3.diff

    compiler.c_standard 2011

    configure.args      -Dc_std=c11 \
                        -Dosmesa=true

    configure.cflags-append -Wno-implicit-fallthrough

    variant python39 description {Use python 3.9} {
        depends_build-append    port:py39-mako
        post-patch {
            reinplace "s|@@PYTHON3@@|${prefix}/bin/python3.9|g" meson.build
        }
    }

    if {![variant_isset python39]} {
        default_variants-append +python39
    }

    variant tests description {enable tests} {
        test.run yes
        test.target test
        configure.args-append -Dbuild-tests=true
    }

    livecheck.type  regex
    livecheck.url   ${homepage}
    livecheck.regex {relnotes/([0-9.]+)\.html}


# fallback mesa for older systems <= darwin 15 for now at least
} else {

    PortGroup           compiler_blacklist_versions 1.0

    PortGroup           legacysupport 1.0

    legacysupport.newest_darwin_requires_legacy 15

    license_noconflict  py27-libxml2

    version             19.0.8
    revision            1
	checksums			rmd160  9b891d625d8af5e3455683a0b10e23a11491759b \
						sha256  1a3dc3f2af853c76aadb4a1e03c9ba420361c04a742d457a702b781671a96a57 \
						size    20086282

    depends_build       port:pkgconfig \
                        port:flex \
                        port:bison \
                        port:gindent

    depends_lib         port:expat \
                        port:xorg-xorgproto \
                        port:xorg-libxcb \
                        port:xorg-libX11 \
                        port:xorg-libXext \
                        port:xorg-libXdamage \
                        port:xorg-libXfixes \
                        port:xorg-libXi \
                        port:xorg-libXmu \
                        port:xorg-libXxf86vm

    patch.pre_args      -p1
    patchfiles \
        old_patches/0001-applegl-Provide-requirements-of-_SET_DrawBuffers.patch \
        old_patches/0002-Fall-back-on-clock_gettime-when-timespec_get-is-unav.patch

    use_autoreconf      yes
    autoreconf.args     -fvi

    configure.args \
        --enable-autotools \
        --disable-silent-rules \
        --with-platforms=x11 \
        --disable-egl \
        --disable-gbm \
        --disable-osmesa \
        --disable-llvm-shared-libs \
        --with-gallium-drivers=

    # mesa builds with -std=c99 but uses timespec_get() which was added in c11, so this works around that bug
    configure.env-append \
        export ac_cv_func_timespec_get=no

    configure.env-append \
        INDENT=${prefix}/bin/gindent

    # This project is affected by a bug in Apple's gcc driver driver that I fixed in the apple-gcc42 port.
    # Use that or clang.
    # clang-700.1.81 (Xcode 7.2.1) fails at:
    #     disk_cache.c:637:7: error: cannot compile this atomic library call yet
    #           p_atomic_add(cache->size, - (uint64_t)sb.st_blocks * 512);
    #           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    compiler.blacklist gcc-3.3 gcc-4.0 gcc-4.2 llvm-gcc-4.2 {clang < 800}

    platform darwin {
        if {${os.major} < 11} {


# REMOVE ALL BELOW ONCE NEW LEGACYSUPPORT HAS BEEN RELEASED

            # this will be fixed after a new legacysupport rolls out
            version             17.1.6
            revision            2
            checksums           sha1    2acc201e24ea67c5231074d6746a42a747228ed6 \
                                rmd160  43a9b758462316ad344ccdccf72d6d0ce295620e \
                                sha256  0686deadde1f126b20aa67e47e8c50502043eee4ecdf60d5009ffda3cebfee50 \
                                size    9868932

            # this option does nothing in mesa 17.x and generates warnings
            configure.args-delete --enable-autotools

            # overwrite previous patchfiles, and then add as needed below
            patchfiles \
                old_patches/mesa17-0001-glxcmds-Fix-a-typo-in-the-__APPLE__-codepath.patch \
                old_patches/mesa17-0002-glext.h-Add-missing-include-of-stddef.h-for-ptrdiff_.patch \
                old_patches/mesa17-0003-applegl-Provide-requirements-of-_SET_DrawBuffers.patch \
                old_patches/mesa17-0004-mesa-Deal-with-size-differences-between-GLuint-and-G.patch

# REMOVE ALL ABOVE ONCE NEW LEGACYSUPPORT HAS BEEN RELEASED




            # https://bugs.freedesktop.org/show_bug.cgi?id=89088
            configure.env-append INDENT=cat

            # not needed if legacysupport is used
            # patchfiles-append static-strndup.patch
        }

        if {${os.major} < 10} {
            # https://trac.macports.org/ticket/52811
            patchfiles-append old_patches/patch-include-GL-mesa_glinterop_h.diff
        }

        if {${os.major} < 11} {
            # See https://trac.macports.org/ticket/54643
            configure.args-append --disable-glx-tls
        }

        if {${os.major} < 14} {
            # See https://trac.macports.org/ticket/54638
            # See https://trac.macports.org/ticket/54643
            patchfiles-append old_patches/disable_shader_cache.patch
        }

        if {${os.major} < 9} {
              # Xplugin.h is missing on Tiger
              configure.cppflags-append -I${filespath}/old_patches/include
        }

        pre-configure {
            if {${os.major} < 11} {
                # https://trac.macports.org/ticket/25677
                if { ![file exists /usr/lib/libXplugin.dylib] } {
                    ui_error "Detected a problem with your development environment.  Please work around it by executing:"
                    ui_error "sudo ln -s libXplugin.1.dylib /usr/lib/libXplugin.dylib"
                    return -code error "missing libXplugin.dylib"
                }
            }
        }
    }

    if {[string match *gcc* ${configure.compiler}]} {
        # Older gcc fail to do -Werror=missing-prototypes correctly
        # https://trac.macports.org/ticket/46827
        patchfiles-append old_patches/no-missing-prototypes-error.patch
    }

    configure.cppflags-delete -I${prefix}/include

    variant python27 description {Use python 2.7} {
        depends_build-append \
            port:py27-libxml2
        configure.env-append \
            PYTHON2=${prefix}/bin/python2.7
    }

    if {![variant_isset python27]} {
        default_variants-append +python27
    }

    variant osmesa description {enable OSMesa library} {
        configure.args-delete --disable-osmesa
        configure.args-append --enable-osmesa
    }
    default_variants-append +osmesa

    livecheck.type  none

}

